<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categories Management</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
    --primary: #4f46e5;
    --primary-dark: #4338ca;
    --secondary: #f472b6;
    --accent: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --dark: #1f2937;
    --light: #f9fafb;
}

body { background: linear-gradient(135deg, #e0eaff, #fef9ff); font-family:'Roboto',sans-serif; min-height:100vh; margin:0; }

/* Glass card */
.glass-card { background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius:20px; box-shadow:0 12px 40px rgba(0,0,0,0.08); border:1px solid rgba(255,255,255,0.4); transition: transform 0.3s ease, box-shadow 0.3s ease; overflow:hidden; }
.glass-card:hover { transform: translateY(-5px); box-shadow:0 20px 50px rgba(0,0,0,0.12); }

/* Category card */
.category-card { position: relative; overflow: hidden; }
.category-card::before { content:''; position:absolute; top:0; left:0; right:0; height:4px; background: linear-gradient(90deg, var(--primary), var(--secondary)); transform: scaleX(0); transform-origin:left; transition: transform 0.4s ease; }
.category-card:hover::before { transform: scaleX(1); }

/* Posts badge */
.posts-badge { background: linear-gradient(135deg, var(--primary), var(--secondary)); color:white; border-radius:50%; width:28px; height:28px; display:flex; align-items:center; justify-content:center; font-size:0.75rem; font-weight:bold; box-shadow:0 4px 10px rgba(79,70,229,0.3); }

/* Modal */
.modal { display:none; position:fixed; inset:0; z-index:50; justify-content:center; align-items:center; background:rgba(0,0,0,0.5); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); padding:1rem; }
.modal.active { display:flex; }
.modal-content { width:100%; max-width:600px; }

/* Floating button */
.floating-btn { position:fixed; bottom:2rem; right:2rem; width:60px; height:60px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 25px rgba(79,70,229,0.4); cursor:pointer; z-index:40; transition: transform 0.3s ease, box-shadow 0.3s ease; animation:pulse 2s infinite; }
.floating-btn:hover { transform: scale(1.1) rotate(90deg); box-shadow:0 12px 30px rgba(79,70,229,0.5); animation:none; }

/* Post item */
.post-item { display:flex; justify-content:space-between; align-items:center; padding:0.75rem; margin-bottom:0.5rem; border-radius:12px; background: rgba(255,255,255,0.7); transition: transform 0.2s ease, background 0.2s ease; border:1px solid rgba(229,231,235,0.5); }
.post-item:hover { background: rgba(255,255,255,0.9); transform: translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.05); }
.post-item button { opacity:0; transition: opacity 0.2s ease; }
.post-item:hover button { opacity:1; }

/* Inputs and buttons */
input, textarea { border-radius:12px; border:1px solid rgba(200,200,200,0.5); background:rgba(255,255,255,0.9); padding:0.65rem 1rem; font-size:0.95rem; transition:all 0.2s ease; color:var(--dark); box-shadow:0 2px 4px rgba(0,0,0,0.03); }
input:focus, textarea:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(79,70,229,0.15); transform:translateY(-1px); }
button { border-radius:12px; padding:0.55rem 1rem; font-weight:500; cursor:pointer; transition:all 0.2s ease; position:relative; overflow:hidden; }
button:hover { transform: translateY(-2px); box-shadow:0 6px 15px rgba(79,70,229,0.25); }

/* Collapsible */
.section-toggle:hover { background: linear-gradient(90deg,#6366f1,#ec4899); color:white; }
.section-toggle i { transition: transform 0.3s; }
.section-content { transition: max-height 0.3s ease, padding 0.3s ease; }

/* Responsive */
@media (max-width:640px) {
    .modal .glass-card { margin:0.5rem; max-height:95vh; }
    .floating-btn { bottom:1rem; right:1rem; width:50px; height:50px; }
    header { flex-direction: column; align-items: flex-start; }
    #searchInput { width:100%; margin-bottom:1rem; }
}

/* Animations */
@keyframes pulse { 0%,100%{transform:scale(1);}50%{transform:scale(1.05);} }
@keyframes ripple {0%{transform:scale(0,0);opacity:0.5;}100%{transform:scale(20,20);opacity:0;} }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-6">

<!-- Header -->
<header class="w-full max-w-7xl flex flex-col md:flex-row items-center justify-between mb-8">
    <div class="flex items-center mb-4 md:mb-0">
        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-500 to-indigo-600 flex items-center justify-center mr-3 shadow-md">
            <i class="fas fa-folder text-white"></i>
        </div>
        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Categories Management</h1>
    </div>
    <div class="flex items-center w-full md:w-auto">
        <div class="relative flex-1 md:flex-none">
            <input type="text" id="searchInput" placeholder="Search categories..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg w-full md:w-64 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
        </div>
    </div>
</header>

<!-- Info Bar -->
<div class="w-full max-w-7xl flex justify-between items-center mb-6">
    <div class="text-lg font-semibold text-gray-700">
        Total Categories: <span id="catCount" class="text-indigo-600 text-2xl font-bold">0</span>
    </div>
    <div class="text-sm text-gray-500">
        Click on a category to view and manage posts
    </div>
</div>

<!-- Notification -->
<div id="notification" class="fixed top-6 right-6 px-4 py-3 rounded-lg shadow-lg hidden z-50 transition-all duration-300"></div>

<!-- Categories Grid -->
<main id="catsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full max-w-7xl">
    <div class="col-span-full flex justify-center items-center py-12">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Loading categories...</p>
        </div>
    </div>
</main>

<!-- Floating Action Button -->
<div class="floating-btn" id="newCatBtn">
    <i class="fas fa-plus text-xl"></i>
</div>

<!-- Edit/Add Category Modal -->
<div id="categoryModal" class="modal">
    <div class="glass-card p-6">
        <h2 id="modalTitle" class="text-xl font-bold mb-4"></h2>
        <div class="section mb-4">
            <button class="section-toggle w-full flex justify-between items-center py-3 px-4 bg-indigo-100 rounded-lg font-medium text-indigo-800">
                Category Details
                <i class="fas fa-chevron-down transition-transform"></i>
            </button>
            <div class="section-content max-h-0 overflow-hidden transition-all duration-300 p-4">
                <label for="modalEditName" class="block text-sm font-medium text-gray-700 mb-1">Category Name</label>
                <input id="modalEditName" placeholder="Enter category name" class="w-full mb-3 px-4 py-3 border rounded-lg">

                <label for="modalEditSlug" class="block text-sm font-medium text-gray-700 mb-1">Slug</label>
                <input id="modalEditSlug" placeholder="Enter slug" class="w-full mb-3 px-4 py-3 border rounded-lg">

                <label for="modalEditDesc" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="modalEditDesc" rows="3" class="w-full px-4 py-3 border rounded-lg"></textarea>
            </div>
        </div>

        <div class="section mb-6">
            <button class="section-toggle w-full flex justify-between items-center py-3 px-4 bg-red-100 rounded-lg font-medium text-red-600">
                Delete / Advanced
                <i class="fas fa-chevron-down transition-transform"></i>
            </button>
            <div class="section-content max-h-0 overflow-hidden transition-all duration-300 p-4">
                <button id="modalDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 w-full">
                    Delete Category
                </button>
            </div>
        </div>

        <div class="flex justify-between items-center pt-4 border-t border-gray-200">
            <button id="modalCancelBtn" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 hover:bg-gray-400 flex items-center transition-all duration-300">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <button id="modalSaveBtn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 flex items-center transition-all duration-300">
                <i class="fas fa-save mr-2"></i>Save Category
            </button>
        </div>
    </div>
</div>

<!-- Posts Management Modal -->
<div id="postsModal" class="modal">
    <div class="glass-card p-6">
        <h2 id="postsModalTitle" class="text-xl font-bold mb-4"></h2>

        <div class="section mb-4">
            <button class="section-toggle w-full flex justify-between items-center py-3 px-4 bg-green-100 rounded-lg font-medium text-green-800">
                Current Posts
                <i class="fas fa-chevron-down transition-transform"></i>
            </button>
            <div class="section-content max-h-0 overflow-hidden transition-all duration-300 p-2">
                <div id="modalCategoryPostsList" class="space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
        </div>

        <div class="section mb-4">
            <button class="section-toggle w-full flex justify-between items-center py-3 px-4 bg-indigo-100 rounded-lg font-medium text-indigo-800">
                Add Posts
                <i class="fas fa-chevron-down transition-transform"></i>
            </button>
            <div class="section-content max-h-0 overflow-hidden transition-all duration-300 p-2">
                <div class="flex space-x-2 mb-3">
                    <input type="text" id="modalPostsSearch" placeholder="Search posts..." class="flex-1 px-4 py-2 border rounded-lg">
                    <button id="modalSearchPostsBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div id="modalAvailablePostsList" class="space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
        </div>

        <div class="flex justify-end pt-4 border-t border-gray-200">
            <button id="modalClosePostsBtn" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 hover:bg-gray-400 flex items-center transition-all duration-300">
                <i class="fas fa-times mr-2"></i>Close
            </button>
        </div>
    </div>
</div>
<script>
    let categories = [];
let allPosts = [];
let currentCat = null;
let currentPosts = [];

const catsContainer = document.getElementById("catsContainer");

// Modals
const editModal = document.getElementById("categoryModal");
const modalTitle = document.getElementById("modalTitle");
const editName = document.getElementById("modalEditName");
const editSlug = document.getElementById("modalEditSlug");
const editDesc = document.getElementById("modalEditDesc");
const saveBtn = document.getElementById("modalSaveBtn");
const deleteBtn = document.getElementById("modalDeleteBtn");
const cancelBtn = document.getElementById("modalCancelBtn");

const newCatBtn = document.getElementById("newCatBtn");
const searchInput = document.getElementById("searchInput");
const notification = document.getElementById("notification");
const catCount = document.getElementById("catCount");

// Posts modal
const postsModal = document.getElementById("postsModal");
const postsModalTitle = document.getElementById("postsModalTitle");
const categoryPostsList = document.getElementById("modalCategoryPostsList");
const availablePostsList = document.getElementById("modalAvailablePostsList");
const postsSearch = document.getElementById("modalPostsSearch");
const searchPostsBtn = document.getElementById("modalSearchPostsBtn");
const closePostsModalBtn = document.getElementById("modalClosePostsBtn");

document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("token");
    if (!token) return window.location.href="../login/index.html";

    const AUTH_HEADERS = {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
    };

    async function loadCategories(){
        try{
            const res = await fetch("https://jesse-network.site/wp-json/wp/v2/categories?per_page=100",{headers:AUTH_HEADERS});
            if(!res.ok) throw new Error(res.status);
            categories = await res.json();
            renderCats(categories);
            animateCount(categories.length);
        }catch(err){
            catsContainer.innerHTML=`<div class="col-span-full flex justify-center items-center py-12"><div class="text-center">
            <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i></div>
            <p class="text-red-500 font-medium">Failed to load categories</p>
            </div></div>`;
        }
    }

    async function loadPosts(){
        try{
            const res = await fetch("https://jesse-network.site/wp-json/wp/v2/posts?per_page=100&_embed",{headers:AUTH_HEADERS});
            if(!res.ok) throw new Error(res.status);
            allPosts = await res.json();
        }catch(err){ console.error("Failed to load posts:",err); }
    }

    function renderCats(data){
        catsContainer.innerHTML="";
        if(data.length===0){
            catsContainer.innerHTML=`<div class="col-span-full flex justify-center items-center py-12">
            <div class="text-center"><div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-inbox text-gray-400 text-xl"></i></div>
            <p class="text-gray-500 font-medium">No categories found</p></div></div>`;
            return;
        }

        data.forEach(cat=>{
            const card=document.createElement("div");
            card.className="glass-card category-card p-5";

            const postsCount = allPosts.filter(post => post.categories && post.categories.includes(cat.id)).length;

            card.innerHTML=`
                <div class="flex justify-between items-start mb-3">
                    <h3 class="font-bold text-lg text-gray-900">${cat.name}</h3>
                    <div class="posts-badge">${postsCount}</div>
                </div>
                <p class="text-gray-600 text-sm mb-4">${cat.description||"No description"}</p>
                <div class="flex justify-between items-center">
                    <span class="bg-indigo-100 text-indigo-600 text-xs px-2 py-1 rounded">ID: ${cat.id}</span>
                    <div class="category-actions flex space-x-2">
                        <button class="edit-cat-btn text-indigo-600 hover:text-indigo-800" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="manage-posts-btn text-green-600 hover:text-green-800" title="Manage Posts">
                            <i class="fas fa-folder-open"></i>
                        </button>
                    </div>
                </div>`;
            catsContainer.appendChild(card);

            card.querySelector(".edit-cat-btn").addEventListener("click",()=>openEditModal(cat));
            card.querySelector(".manage-posts-btn").addEventListener("click",()=>openPostsModal(cat));
        });
    }

    function animateCount(num){
        let start=0;
        const duration=800;
        const stepTime=Math.abs(Math.floor(duration/num));
        const timer=setInterval(()=>{
            start++;
            catCount.textContent=start;
            if(start>=num) clearInterval(timer);
        },stepTime);
    }

    function openEditModal(cat=null){
        currentCat=cat;
        modalTitle.textContent=cat?`Edit Category: ${cat.name}`:"Add New Category";
        editName.value=cat?.name||"";
        editSlug.value=cat?.slug||"";
        editDesc.value=cat?.description||"";
        editModal.classList.add("active");
    }

    saveBtn.addEventListener("click",async ()=>{
        const payload={name:editName.value,slug:editSlug.value,description:editDesc.value};
        try{
            let url="https://jesse-network.site/wp-json/wp/v2/categories";
            let method="POST";
            if(currentCat) { url+=`/${currentCat.id}`; method="PUT"; }

            const res=await fetch(url,{method,headers:{"Authorization":"Bearer "+localStorage.getItem("token"),"Content-Type":"application/json"},body:JSON.stringify(payload)});
            if(!res.ok) throw new Error(res.status);
            showNotification(currentCat?"Category updated":"Category added","success");
            editModal.classList.remove("active");
            await loadCategories();
        }catch(err){ showNotification("Failed to save category","error"); }
    });

    deleteBtn.addEventListener("click",async ()=>{
        if(!currentCat) return;
        if(!confirm("Are you sure you want to delete this category?")) return;
        try{
            const res=await fetch(`https://jesse-network.site/wp-json/wp/v2/categories/${currentCat.id}`,{method:"DELETE",headers:{"Authorization":"Bearer "+localStorage.getItem("token")}});
            if(!res.ok) throw new Error(res.status);
            showNotification("Category deleted","success");
            editModal.classList.remove("active");
            await loadCategories();
        }catch(err){ showNotification("Failed to delete category","error"); }
    });

    cancelBtn.addEventListener("click",()=>editModal.classList.remove("active"));
    newCatBtn.addEventListener("click",()=>openEditModal());

    searchInput.addEventListener("input",()=>renderCats(categories.filter(cat=>cat.name.toLowerCase().includes(searchInput.value.toLowerCase()))));

    function showNotification(msg,type="success"){
        notification.textContent=msg;
        notification.className=`fixed top-6 right-6 px-4 py-3 rounded-lg shadow-lg z-50 ${type==="success"?"bg-green-500 text-white":"bg-red-500 text-white"}`;
        notification.classList.add("show");
        setTimeout(()=>{ notification.classList.remove("show"); notification.textContent=""; },3000);
    }

    // --- Posts Modal ---
    async function openPostsModal(cat){
        currentCat=cat;
        postsModal.classList.add("active");
        postsModalTitle.textContent=`Posts for ${cat.name}`;
        renderCategoryPosts();
        renderAvailablePosts();
    }

    function renderCategoryPosts(){
        categoryPostsList.innerHTML="";
        currentPosts = allPosts.filter(p=>p.categories.includes(currentCat.id));
        if(currentPosts.length===0) categoryPostsList.innerHTML="<p class='text-gray-500'>No posts in this category</p>";
        else currentPosts.forEach(post=>{
            const div=document.createElement("div");
            div.className="post-item";
            div.innerHTML=`<span>${post.title.rendered}</span><button class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-sm">Remove</button>`;
            div.querySelector("button").addEventListener("click",async ()=>{
                try{
                    const newCats=post.categories.filter(c=>c!==currentCat.id);
                    await fetch(`https://jesse-network.site/wp-json/wp/v2/posts/${post.id}`,{method:"PUT",headers:{"Authorization":"Bearer "+localStorage.getItem("token"),"Content-Type":"application/json"},body:JSON.stringify({categories:newCats})});
                    showNotification("Post removed","success"); renderCategoryPosts(); renderAvailablePosts();
                }catch(err){ showNotification("Failed to remove","error"); }
            });
            categoryPostsList.appendChild(div);
        });
    }

    function renderAvailablePosts(){
        availablePostsList.innerHTML="";
        const filteredPosts=allPosts.filter(p=>!p.categories.includes(currentCat.id));
        if(filteredPosts.length===0) availablePostsList.innerHTML="<p class='text-gray-500'>No available posts</p>";
        else filteredPosts.forEach(post=>{
            const div=document.createElement("div");
            div.className="post-item";
            div.innerHTML=`<span>${post.title.rendered}</span><button class="bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded text-sm">Add</button>`;
            div.querySelector("button").addEventListener("click",async ()=>{
                try{
                    const newCats=[...post.categories,currentCat.id];
                    await fetch(`https://jesse-network.site/wp-json/wp/v2/posts/${post.id}`,{method:"PUT",headers:{"Authorization":"Bearer "+localStorage.getItem("token"),"Content-Type":"application/json"},body:JSON.stringify({categories:newCats})});
                    showNotification("Post added","success"); renderCategoryPosts(); renderAvailablePosts();
                }catch(err){ showNotification("Failed to add","error"); }
            });
            availablePostsList.appendChild(div);
        });
    }

    closePostsModalBtn.addEventListener("click",()=>postsModal.classList.remove("active"));

    // Section collapsibles
    document.querySelectorAll(".section-toggle").forEach(toggle=>{
        toggle.addEventListener("click",()=>{
            const content=toggle.nextElementSibling;
            content.style.maxHeight=content.style.maxHeight?null:content.scrollHeight+"px";
            toggle.querySelector("i").style.transform=content.style.maxHeight?"rotate(180deg)":"rotate(0deg)";
        });
    });

    await loadPosts();
    await loadCategories();
});

</script>
<script src="app.js"></script>
</body>
</html>
